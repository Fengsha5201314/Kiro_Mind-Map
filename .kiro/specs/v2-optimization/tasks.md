# AI思维导图生成器 v2.0 优化实施计划

本文档定义了v2.0版本三项核心优化功能的实施任务列表。

---

## 第一阶段：智能提示词工程 ✅ 已完成

### 1. 创建内容类型检测系统 ✅

- [x] 1.1 实现ContentTypeDetector服务
  - 已创建 `src/services/contentTypeDetector.ts`
  - 已实现基于关键词和模式匹配的内容类型识别算法
  - 支持识别：技术文档、会议记录、学习笔记、项目计划、头脑风暴等类型
  - _需求: 1.1_

- [x] 1.2 创建内容类型定义和接口
  - 已在 `src/types/contentType.ts` 中定义 ContentType 枚举和相关接口
  - 已定义检测结果的数据结构
  - _需求: 1.1_

- [ ]* 1.3 编写内容类型检测的单元测试
  - 测试各种内容类型的识别准确性
  - 测试边界情况和混合内容
  - _需求: 1.1_

### 2. 构建提示词模板系统 ✅

- [x] 2.1 创建提示词模板管理器
  - 已创建 `src/services/promptTemplateManager.ts`
  - 已实现模板注册、选择和渲染功能
  - 支持动态变量替换
  - _需求: 1.2, 1.3_

- [x] 2.2 设计和实现提示词模板
  - 已创建 `src/config/promptTemplates.ts`
  - 已实现技术文档模板（强调概念层次、API结构）
  - 已实现会议记录模板（强调议题、决策、行动项）
  - 已实现学习笔记模板（强调知识点、关联关系）
  - 已实现项目计划模板（强调任务、时间线、依赖）
  - 已实现头脑风暴模板和通用模板
  - 已集成MECE原则和金字塔原理到模板中
  - _需求: 1.2, 1.4_

- [ ]* 2.3 编写提示词模板的属性测试
  - **属性1：模板变量替换完整性**
  - **验证需求: 1.2**
  - 对任意有效的模板和变量集，替换后的提示词应包含所有必需的结构化要求

### 3. 集成提示词引擎到生成流程 ✅

- [x] 3.1 更新geminiService以支持动态提示词
  - 已修改 `src/services/geminiService.ts`
  - 已集成ContentTypeDetector和PromptTemplateManager
  - 已实现提示词选择逻辑
  - _需求: 1.2_

- [x] 3.2 添加UI组件显示识别的内容类型
  - 已创建 `src/components/Input/ContentTypeSelector.tsx`
  - 已实现内容类型显示和确认功能
  - 允许用户手动调整识别结果
  - _需求: 1.1_

- [ ]* 3.3 编写端到端集成测试
  - 测试从内容输入到提示词生成的完整流程
  - 验证不同内容类型使用正确的模板
  - _需求: 1.1, 1.2_

---

## 第二阶段：流式生成 ✅ 已完成

### 4. 实现流式API集成 ✅

- [x] 4.1 创建流式生成服务
  - 已创建 `src/services/streamingService.ts`
  - 已集成Gemini的streamGenerateContent API
  - 已实现流式数据解析器（支持部分JSON解析）
  - 已实现错误处理和降级机制
  - _需求: 2.1_

- [x] 4.2 实现流式数据解析器
  - 已创建增量JSON解析器，处理不完整的JSON片段
  - 已实现节点数据提取逻辑
  - 已处理流式传输中的错误和中断
  - _需求: 2.1_

- [ ]* 4.3 编写流式服务的单元测试
  - 测试流式数据的正确解析
  - 测试错误处理和降级逻辑
  - _需求: 2.1_

### 5. 实现实时渲染系统 ✅

- [x] 5.1 更新mindmapStore支持增量更新
  - 已修改 `src/stores/mindmapStore.ts`
  - 已添加增量添加节点的方法（addNodesIncremental, updatePartialMindMap）
  - 已实现生成状态管理（GenerationStatus枚举：进行中、已完成、已取消、错误）
  - _需求: 2.2, 2.4_

- [x] 5.2 实现渐进式节点渲染
  - Canvas.tsx已支持增量节点渲染
  - 已实现自动布局调整以容纳新节点
  - _需求: 2.2_

- [x] 5.3 添加生成进度指示器
  - 已创建 `src/components/Common/ProgressIndicator.tsx`
  - 已实现ProgressBar和ProgressStep组件
  - 支持进度计算和动画效果
  - _需求: 2.3_

- [ ]* 5.4 编写实时渲染的属性测试
  - **属性2：增量渲染一致性**
  - **验证需求: 2.2**
  - 对任意节点序列，增量添加的最终结果应与一次性添加相同

### 6. 实现用户交互控制

- [ ] 6.1 集成流式生成到UI
  - 在主应用组件中集成streamingService
  - 添加流式生成的触发逻辑
  - 实现进度显示和取消按钮
  - 保留已生成的部分内容
  - _需求: 2.1, 2.4_

- [ ] 6.2 优化生成完成后的交互
  - 实现完成提示和动画
  - 确保生成完成后可立即编辑
  - 移除进度指示器
  - _需求: 2.3, 2.4_

- [ ]* 6.3 编写用户交互的集成测试
  - 测试取消功能的正确性
  - 测试部分内容的保留和编辑
  - _需求: 2.4_

### 7. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

---

## 第三阶段：多种布局模式 ✅ 已完成

### 8. 实现布局引擎核心 ✅

- [x] 8.1 创建布局引擎服务
  - 已创建 `src/services/layoutEngine.ts`
  - 已定义布局接口和LayoutEngine类
  - 已实现布局切换管理器
  - _需求: 3.1_

- [x] 8.2 定义布局类型和配置
  - 已在 `src/types/layout.ts` 中定义LayoutMode枚举
  - 已定义布局配置接口（节点间距、对齐方式等）
  - _需求: 3.1_

### 9. 实现各种布局算法 ✅

- [x] 9.1 实现水平树形布局算法
  - 已实现，根节点位于左侧，子节点向右展开
  - 子节点垂直对称分布
  - 动态调整节点间距
  - _需求: 3.2_

- [x] 9.2 实现垂直树形布局算法
  - 已实现，根节点位于顶部，子节点向下展开
  - 子节点水平对称分布
  - 适用于组织架构图
  - _需求: 3.3_

- [x] 9.3 实现辐射状布局算法
  - 已实现，根节点位于中心，子节点环绕分布
  - 子节点均匀分布在圆周上
  - 适用于头脑风暴场景
  - _需求: 3.4_

- [x] 9.4 实现鱼骨图布局算法
  - 已实现，主题位于右侧，分支向左展开
  - 主要分支分布在主干上下两侧
  - 子分支以斜线形式连接
  - _需求: 3.5_

- [ ]* 9.5 编写布局算法的属性测试
  - **属性3：布局边界约束**
  - **验证需求: 3.2, 3.3, 3.4, 3.5**
  - 对任意思维导图结构，所有布局算法生成的节点位置应在画布边界内
  
- [ ]* 9.6 编写布局算法的属性测试
  - **属性4：节点不重叠**
  - **验证需求: 3.2, 3.3, 3.4, 3.5**
  - 对任意思维导图结构和布局模式，任意两个节点不应重叠

### 10. 实现布局切换UI ✅

- [x] 10.1 创建布局选择器组件
  - 已创建 `src/components/MindMap/LayoutSelector.tsx`
  - 已显示可用布局模式列表
  - 已提供布局预览图标
  - _需求: 3.1_

- [ ] 10.2 实现布局切换动画
  - 实现节点位置的平滑过渡动画
  - 使用CSS Transitions或RequestAnimationFrame
  - 确保动画时长 < 300ms
  - _需求: 3.1_

- [ ] 10.3 集成布局选择器到控制面板和Canvas
  - 在Controls.tsx中添加布局切换按钮
  - 在Canvas.tsx中集成layoutEngine
  - 实现布局切换时的节点位置更新
  - _需求: 3.1_

### 11. 实现布局持久化

- [ ] 11.1 更新数据模型支持布局信息
  - 修改 `src/types/mindmap.ts`
  - 添加layoutMode字段到思维导图数据结构
  - _需求: 3.6_

- [ ] 11.2 实现布局保存和恢复
  - 修改 `src/stores/mindmapStore.ts`（已有setLayout方法）
  - 保存布局选择到本地存储
  - 加载时恢复布局模式
  - _需求: 3.6_

- [ ]* 11.3 编写布局持久化的属性测试
  - **属性5：布局持久化往返一致性**
  - **验证需求: 3.6**
  - 对任意布局模式，保存后重新加载应恢复相同的布局

### 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
  - 验证三大功能的集成效果
  - 进行性能测试（流式生成延迟 < 500ms，布局切换 < 300ms）

---

## 实施注意事项

### 代码质量要求
- 所有新代码必须使用TypeScript严格模式
- 遵循现有的代码风格和命名规范
- 添加必要的代码注释（中文）
- 确保向后兼容现有功能

### 测试要求
- 核心功能必须有单元测试覆盖
- 关键属性必须有属性测试验证
- 集成测试验证端到端流程

### 性能要求
- 流式生成延迟 < 500ms
- 布局切换动画 < 300ms
- 内容类型检测 < 100ms

### 兼容性要求
- 保持现有数据结构兼容
- 支持现有的导出功能
- 不破坏现有的用户数据

---

## 依赖关系

- 任务1-3已完成（提示词系统）✅
- 任务4-5已完成（流式生成核心）✅
- 任务6需要完成（UI集成）
- 任务8-10已完成（布局引擎核心）✅
- 任务10.2-10.3和11需要完成（布局UI集成和持久化）
- 任务12必须在所有其他任务完成后执行
